<UserControl
  x:Class="BioDesk.App.Views.ListaPacientesView"
  xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
  xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
  xmlns:converters="clr-namespace:BioDesk.App.Converters"
  xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
  xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
  xmlns:vm="clr-namespace:BioDesk.ViewModels;assembly=BioDesk.ViewModels"
  d:DataContext="{d:DesignInstance Type=vm:ListaPacientesViewModel}"
  d:DesignHeight="800"
  d:DesignWidth="1400"
  Background="#FCFDFB"
  mc:Ignorable="d">

  <UserControl.Resources>
    <BooleanToVisibilityConverter x:Key="BoolToVisibility" />
    <converters:NullToBoolConverter x:Key="NullToBoolConverter" />
  </UserControl.Resources>

  <Grid>
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto" />
      <RowDefinition Height="Auto" />
      <RowDefinition Height="*" />
      <RowDefinition Height="Auto" />
    </Grid.RowDefinitions>

    <!--  Header  -->
    <Border
      Grid.Row="0"
      Padding="24,16"
      Background="#9CAF97">
      <Grid>
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="*" />
          <ColumnDefinition Width="Auto" />
        </Grid.ColumnDefinitions>

        <StackPanel Grid.Column="0" Orientation="Horizontal">
          <TextBlock
            VerticalAlignment="Center"
            FontSize="24"
            FontWeight="Bold"
            Foreground="White"
            Text="📋 Lista de Pacientes" />

          <Border
            Margin="16,0,0,0"
            Padding="12,6"
            Background="White"
            CornerRadius="12">
            <TextBlock
              FontSize="14"
              FontWeight="SemiBold"
              Foreground="#3F4A3D">
              <Run Text="{Binding TotalPacientes, Mode=OneWay}" />
              <Run Text="paciente(s)" />
            </TextBlock>
          </Border>
        </StackPanel>

        <Button
          Grid.Column="1"
          Padding="16,8"
          VerticalAlignment="Center"
          Background="White"
          BorderThickness="0"
          Command="{Binding VoltarDashboardCommand}"
          Content="⬅ Voltar ao Dashboard"
          Cursor="Hand"
          FontSize="14"
          FontWeight="SemiBold"
          Foreground="#3F4A3D">
          <Button.Style>
            <Style TargetType="Button">
              <Setter Property="Template">
                <Setter.Value>
                  <ControlTemplate TargetType="Button">
                    <Border
                      Padding="{TemplateBinding Padding}"
                      Background="{TemplateBinding Background}"
                      CornerRadius="6">
                      <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                    </Border>
                  </ControlTemplate>
                </Setter.Value>
              </Setter>
              <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                  <Setter Property="Background" Value="#F0F0F0" />
                </Trigger>
              </Style.Triggers>
            </Style>
          </Button.Style>
        </Button>
      </Grid>
    </Border>

    <!--  Barra de Pesquisa e Ações  -->
    <Border
      Grid.Row="1"
      Padding="24,16"
      Background="#F7F9F6"
      BorderBrush="#E3E9DE"
      BorderThickness="0,0,0,1">
      <Grid>
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="*" />
          <ColumnDefinition Width="Auto" />
          <ColumnDefinition Width="Auto" />
          <ColumnDefinition Width="Auto" />
        </Grid.ColumnDefinitions>

        <!--  Search Box  -->
        <Border
          Grid.Column="0"
          Padding="12"
          Background="White"
          BorderBrush="#E3E9DE"
          BorderThickness="2"
          CornerRadius="8">
          <Grid>
            <Grid.ColumnDefinitions>
              <ColumnDefinition Width="Auto" />
              <ColumnDefinition Width="*" />
              <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <TextBlock
              Grid.Column="0"
              Margin="0,0,8,0"
              VerticalAlignment="Center"
              FontSize="18"
              Text="🔍" />

            <TextBox
              Grid.Column="1"
              VerticalAlignment="Center"
              Background="Transparent"
              BorderThickness="0"
              FontSize="14"
              Text="{Binding TextoPesquisa, UpdateSourceTrigger=PropertyChanged}">
              <TextBox.InputBindings>
                <KeyBinding Key="Enter" Command="{Binding PesquisarCommand}" />
              </TextBox.InputBindings>
              <TextBox.Style>
                <Style TargetType="TextBox">
                  <Style.Triggers>
                    <Trigger Property="Text" Value="">
                      <Setter Property="Background">
                        <Setter.Value>
                          <VisualBrush AlignmentX="Left" Stretch="None">
                            <VisualBrush.Visual>
                              <TextBlock
                                FontSize="14"
                                Foreground="#999"
                                Text="Pesquisar por nome..." />
                            </VisualBrush.Visual>
                          </VisualBrush>
                        </Setter.Value>
                      </Setter>
                    </Trigger>
                  </Style.Triggers>
                </Style>
              </TextBox.Style>
            </TextBox>

            <Button
              Grid.Column="2"
              Padding="16,8"
              Background="#9CAF97"
              BorderThickness="0"
              Command="{Binding PesquisarCommand}"
              Content="Pesquisar"
              Cursor="Hand"
              FontSize="13"
              FontWeight="SemiBold"
              Foreground="White">
              <Button.Style>
                <Style TargetType="Button">
                  <Setter Property="Template">
                    <Setter.Value>
                      <ControlTemplate TargetType="Button">
                        <Border
                          Padding="{TemplateBinding Padding}"
                          Background="{TemplateBinding Background}"
                          CornerRadius="4">
                          <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                        </Border>
                      </ControlTemplate>
                    </Setter.Value>
                  </Setter>
                  <Style.Triggers>
                    <Trigger Property="IsMouseOver" Value="True">
                      <Setter Property="Background" Value="#879B83" />
                    </Trigger>
                  </Style.Triggers>
                </Style>
              </Button.Style>
            </Button>
          </Grid>
        </Border>

        <!--  Botão Eliminar Selecionado  -->
        <Button
          Grid.Column="1"
          Margin="12,0,0,0"
          Padding="16,8"
          Background="#EF4444"
          BorderThickness="0"
          Command="{Binding EliminarPacienteCommand}"
          CommandParameter="{Binding PacienteSelecionado}"
          Content="🗑️ Eliminar"
          Cursor="Hand"
          FontSize="13"
          FontWeight="SemiBold"
          Foreground="White"
          IsEnabled="{Binding PacienteSelecionado, Converter={StaticResource NullToBoolConverter}}"
          ToolTip="Eliminar paciente selecionado (IRREVERSÍVEL!)">
          <Button.Style>
            <Style TargetType="Button">
              <Setter Property="Template">
                <Setter.Value>
                  <ControlTemplate TargetType="Button">
                    <Border
                      Padding="{TemplateBinding Padding}"
                      Background="{TemplateBinding Background}"
                      CornerRadius="6"
                      Opacity="{TemplateBinding Opacity}">
                      <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                    </Border>
                  </ControlTemplate>
                </Setter.Value>
              </Setter>
              <Setter Property="Opacity" Value="1" />
              <Style.Triggers>
                <Trigger Property="IsEnabled" Value="False">
                  <Setter Property="Opacity" Value="0.4" />
                  <Setter Property="Cursor" Value="Arrow" />
                </Trigger>
                <Trigger Property="IsMouseOver" Value="True">
                  <Setter Property="Background" Value="#DC2626" />
                </Trigger>
              </Style.Triggers>
            </Style>
          </Button.Style>
        </Button>

        <!--  Botão Atualizar  -->
        <Button
          Grid.Column="2"
          Margin="12,0,0,0"
          Padding="16,8"
          Background="White"
          BorderBrush="#E3E9DE"
          BorderThickness="2"
          Command="{Binding AtualizarCommand}"
          Content="🔄 Atualizar"
          Cursor="Hand"
          FontSize="13"
          FontWeight="SemiBold"
          Foreground="#3F4A3D">
          <Button.Style>
            <Style TargetType="Button">
              <Setter Property="Template">
                <Setter.Value>
                  <ControlTemplate TargetType="Button">
                    <Border
                      Padding="{TemplateBinding Padding}"
                      Background="{TemplateBinding Background}"
                      BorderBrush="{TemplateBinding BorderBrush}"
                      BorderThickness="{TemplateBinding BorderThickness}"
                      CornerRadius="6">
                      <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                    </Border>
                  </ControlTemplate>
                </Setter.Value>
              </Setter>
              <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                  <Setter Property="Background" Value="#F0F0F0" />
                </Trigger>
              </Style.Triggers>
            </Style>
          </Button.Style>
        </Button>

        <!--  Botão Novo Paciente  -->
        <Button
          Grid.Column="3"
          Margin="12,0,0,0"
          Padding="20,10"
          Background="#4CAF50"
          BorderThickness="0"
          Command="{Binding NovoPacienteCommand}"
          Content="➕ Novo Paciente"
          Cursor="Hand"
          FontSize="14"
          FontWeight="Bold"
          Foreground="White">
          <Button.Style>
            <Style TargetType="Button">
              <Setter Property="Template">
                <Setter.Value>
                  <ControlTemplate TargetType="Button">
                    <Border
                      Padding="{TemplateBinding Padding}"
                      Background="{TemplateBinding Background}"
                      CornerRadius="8">
                      <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                    </Border>
                  </ControlTemplate>
                </Setter.Value>
              </Setter>
              <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                  <Setter Property="Background" Value="#45A049" />
                </Trigger>
              </Style.Triggers>
            </Style>
          </Button.Style>
        </Button>
      </Grid>
    </Border>

    <!--  DataGrid de Pacientes  -->
    <Border
      Grid.Row="2"
      Margin="24"
      Background="White"
      BorderBrush="#E3E9DE"
      BorderThickness="1"
      CornerRadius="8">
      <Grid>
        <!--  Loading Overlay  -->
        <Border
          Panel.ZIndex="999"
          Background="#F0FFFFFF"
          Visibility="{Binding IsLoading, Converter={StaticResource BoolToVisibility}}">
          <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
            <TextBlock
              Margin="0,0,0,16"
              HorizontalAlignment="Center"
              FontSize="48"
              Text="⏳" />
            <TextBlock
              FontSize="16"
              Foreground="#5A6558"
              Text="Carregando pacientes..." />
          </StackPanel>
        </Border>

        <!--  DataGrid  -->
        <DataGrid
          AlternatingRowBackground="#F7F9F6"
          AutoGenerateColumns="False"
          Background="White"
          BorderThickness="0"
          CanUserAddRows="False"
          CanUserDeleteRows="False"
          GridLinesVisibility="Horizontal"
          HeadersVisibility="Column"
          HorizontalGridLinesBrush="#E3E9DE"
          IsReadOnly="True"
          ItemsSource="{Binding Pacientes}"
          MouseDoubleClick="DataGrid_MouseDoubleClick"
          RowBackground="White"
          SelectedItem="{Binding PacienteSelecionado}"
          SelectionMode="Single">

          <DataGrid.Resources>
            <Style TargetType="DataGridColumnHeader">
              <Setter Property="Background" Value="#F7F9F6" />
              <Setter Property="Foreground" Value="#3F4A3D" />
              <Setter Property="FontWeight" Value="SemiBold" />
              <Setter Property="FontSize" Value="13" />
              <Setter Property="Padding" Value="16,12" />
              <Setter Property="BorderThickness" Value="0,0,0,2" />
              <Setter Property="BorderBrush" Value="#E3E9DE" />
            </Style>

            <Style TargetType="DataGridCell">
              <Setter Property="BorderThickness" Value="0" />
              <Setter Property="Padding" Value="16,8" />
              <Setter Property="FontSize" Value="13" />
              <Style.Triggers>
                <Trigger Property="IsSelected" Value="True">
                  <Setter Property="Background" Value="#E8F5E9" />
                  <Setter Property="Foreground" Value="#2E7D32" />
                </Trigger>
              </Style.Triggers>
            </Style>

            <Style TargetType="DataGridRow">
              <Setter Property="Cursor" Value="Hand" />
              <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                  <Setter Property="Background" Value="#F0F4EE" />
                </Trigger>
              </Style.Triggers>
            </Style>
          </DataGrid.Resources>

          <DataGrid.Columns>
            <DataGridTextColumn
              Width="*"
              Binding="{Binding NomeCompleto}"
              Header="Nome Completo" />
            <DataGridTextColumn
              Width="150"
              Binding="{Binding DataNascimento, StringFormat=dd/MM/yyyy}"
              Header="Data Nascimento" />
            <DataGridTextColumn
              Width="80"
              Binding="{Binding Idade}"
              Header="Idade" />
            <DataGridTextColumn
              Width="120"
              Binding="{Binding Genero}"
              Header="Género" />
            <DataGridTextColumn
              Width="120"
              Binding="{Binding NIF}"
              Header="NIF" />
            <DataGridTextColumn
              Width="180"
              Binding="{Binding DataUltimaAtualizacao, StringFormat=dd/MM/yyyy HH:mm}"
              Header="Última Atualização" />
          </DataGrid.Columns>
        </DataGrid>
      </Grid>
    </Border>

    <!--  Footer com Info  -->
    <Border
      Grid.Row="3"
      Padding="24,12"
      Background="#F7F9F6"
      BorderBrush="#E3E9DE"
      BorderThickness="0,1,0,0">
      <TextBlock FontSize="12" Foreground="#5A6558">
        <Run Text="💡 Dica:" />
        <Run Text="Clique duas vezes num paciente para abrir a ficha completa" />
      </TextBlock>
    </Border>
  </Grid>
</UserControl>
