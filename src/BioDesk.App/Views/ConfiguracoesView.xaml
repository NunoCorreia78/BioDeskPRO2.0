<Window
    x:Class="BioDesk.App.Views.ConfiguracoesView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    Title="⚙️ Configurações - BioDeskPro"
    Width="700"
    Height="500"
    Background="{StaticResource FundoPrincipal}"
    ResizeMode="NoResize"
    WindowStartupLocation="CenterOwner"
    mc:Ignorable="d">

    <Window.Resources>
        <!--  Converter para Visibility  -->
        <BooleanToVisibilityConverter x:Key="BoolToVisibility" />

    </Window.Resources>

    <Grid Margin="30">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!--  Cabeçalho  -->
        <StackPanel Grid.Row="0" Margin="0,0,0,25">
            <TextBlock
                FontSize="24"
                FontWeight="SemiBold"
                Foreground="{StaticResource TextoPrincipal}"
                Text="⚙️ Configurações do Sistema" />
            <TextBlock
                Margin="0,5,0,0"
                FontSize="13"
                Foreground="{StaticResource TextoSecundario}"
                Text="Gerir credenciais de email e outras configurações" />
        </StackPanel>

        <!--  Conteúdo Principal com TabControl  -->
        <TabControl
            Grid.Row="1"
            Margin="0,0,0,15"
            TabStripPlacement="Left">
            <TabControl.Resources>
                <Style TargetType="TabItem">
                    <Setter Property="HeaderTemplate">
                        <Setter.Value>
                            <DataTemplate>
                                <TextBlock
                                    Padding="20,15"
                                    FontSize="14"
                                    Text="{Binding}" />
                            </DataTemplate>
                        </Setter.Value>
                    </Setter>
                    <Setter Property="Background" Value="Transparent" />
                    <Setter Property="BorderBrush" Value="#E3E9DE" />
                    <Setter Property="BorderThickness" Value="0,0,1,0" />
                    <Style.Triggers>
                        <Trigger Property="IsSelected" Value="True">
                            <Setter Property="Background" Value="#9CAF97" />
                            <Setter Property="Foreground" Value="White" />
                            <Setter Property="FontWeight" Value="SemiBold" />
                        </Trigger>
                    </Style.Triggers>
                </Style>
            </TabControl.Resources>

            <!--  TAB 1: EMAIL  -->
            <TabItem Header="📧 Email">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel Margin="30">
                        <Border
                            Padding="25"
                            Background="White"
                            BorderBrush="#E3E9DE"
                            BorderThickness="1"
                            CornerRadius="12">
                            <StackPanel>
                                <StackPanel Margin="0,0,0,20" Orientation="Horizontal">
                                    <TextBlock
                                        Margin="0,0,10,0"
                                        FontSize="20"
                                        Text="📧" />
                                    <TextBlock
                                        VerticalAlignment="Center"
                                        FontSize="18"
                                        FontWeight="SemiBold"
                                        Foreground="{StaticResource TextoPrincipal}"
                                        Text="Configurações de Email" />
                                </StackPanel>

                                <StackPanel Margin="0,0,0,15">
                                    <TextBlock Style="{StaticResource FieldLabelStyle}" Text="Email de Envio *" />
                                    <TextBox
                                        Style="{StaticResource FieldTextBoxStyle}"
                                        Tag="exemplo@gmail.com"
                                        Text="{Binding EmailRemetente, UpdateSourceTrigger=PropertyChanged}" />
                                    <TextBlock
                                        Margin="0,4,0,0"
                                        FontSize="10"
                                        Foreground="{StaticResource TextoSecundario}"
                                        Text="Email da conta Gmail que enviará as comunicações" />
                                </StackPanel>

                                <StackPanel Margin="0,0,0,15">
                                    <TextBlock Style="{StaticResource FieldLabelStyle}" Text="App Password do Gmail *" />
                                    <PasswordBox
                                        x:Name="PasswordBox"
                                        PasswordChanged="PasswordBox_PasswordChanged"
                                        Style="{StaticResource FieldPasswordBoxStyle}" />
                                    <TextBlock
                                        Margin="0,4,0,0"
                                        FontSize="10"
                                        Foreground="#D97706"
                                        Text="⚠️ Use uma App Password, não a senha normal da conta" />
                                </StackPanel>

                                <StackPanel Margin="0,0,0,20">
                                    <TextBlock Style="{StaticResource FieldLabelStyle}" Text="Nome do Remetente" />
                                    <TextBox
                                        Style="{StaticResource FieldTextBoxStyle}"
                                        Tag="Clínica de Terapias Naturais"
                                        Text="{Binding NomeRemetente, UpdateSourceTrigger=PropertyChanged}" />
                                    <TextBlock
                                        Margin="0,4,0,0"
                                        FontSize="10"
                                        Foreground="{StaticResource TextoSecundario}"
                                        Text="Nome que aparecerá nos emails enviados" />
                                </StackPanel>

                                <Border
                                    Padding="15"
                                    Background="#FEF3C7"
                                    BorderBrush="#FCD34D"
                                    BorderThickness="1"
                                    CornerRadius="8">
                                    <StackPanel>
                                        <StackPanel Margin="0,0,0,10" Orientation="Horizontal">
                                            <TextBlock
                                                Margin="0,0,8,0"
                                                FontSize="16"
                                                Text="🔐" />
                                            <TextBlock
                                                FontSize="13"
                                                FontWeight="SemiBold"
                                                Foreground="#92400E"
                                                Text="Como Obter uma App Password do Gmail" />
                                        </StackPanel>
                                        <TextBlock
                                            FontSize="11"
                                            Foreground="#92400E"
                                            LineHeight="18"
                                            TextWrapping="Wrap">
                                            <Run Text="1. Aceda a:" />
                                            <Run FontWeight="SemiBold" Text="https://myaccount.google.com/apppasswords" />
                                            <LineBreak />
                                            <Run Text="2. Faça login na sua conta Gmail" />
                                            <LineBreak />
                                            <Run Text="3. Clique em 'Criar' e escolha um nome (ex: BioDeskPro)" />
                                            <LineBreak />
                                            <Run Text="4. Copie a password gerada (16 caracteres) e cole aqui" />
                                            <LineBreak />
                                            <LineBreak />
                                            <Run FontWeight="SemiBold" Text="⚠️ Esta password é diferente da senha normal da sua conta e é mais segura!" />
                                        </TextBlock>
                                    </StackPanel>
                                </Border>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!--  TAB 2: DOCUMENTOS & TEMPLATES  -->
            <TabItem Header="� Documentos">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel Margin="30">
                        <TextBlock
                            Margin="0,0,0,10"
                            FontSize="20"
                            FontWeight="SemiBold"
                            Foreground="{StaticResource TextoPrincipal}"
                            Text="� Gestão de Documentos e Templates" />

                        <TextBlock
                            Margin="0,0,0,30"
                            FontSize="13"
                            Foreground="{StaticResource TextoSecundario}"
                            Text="Templates globais e documentos da clínica (regulamentos, formulários, logos)" />

                        <!--  Secção Templates PDF  -->
                        <Border
                            Margin="0,0,0,20"
                            Padding="25"
                            Background="White"
                            BorderBrush="#E3E9DE"
                            BorderThickness="1"
                            CornerRadius="12">
                            <StackPanel>
                                <StackPanel Margin="0,0,0,15" Orientation="Horizontal">
                                    <TextBlock
                                        Margin="0,0,10,0"
                                        FontSize="18"
                                        Text="📄" />
                                    <TextBlock
                                        FontSize="16"
                                        FontWeight="SemiBold"
                                        Foreground="{StaticResource TextoPrincipal}"
                                        Text="Templates PDF para Prescrições" />
                                </StackPanel>

                                <TextBlock
                                    Margin="0,0,0,15"
                                    FontSize="12"
                                    Foreground="{StaticResource TextoSecundario}"
                                    Text="Ficheiros PDF usados como base para prescrições naturopáticas"
                                    TextWrapping="Wrap" />

                                <Button
                                    Padding="15,10"
                                    HorizontalAlignment="Left"
                                    Background="#9CAF97"
                                    BorderBrush="#879B83"
                                    BorderThickness="0"
                                    Command="{Binding AdicionarNovoTemplatePdfCommand}"
                                    Foreground="White"
                                    ToolTip="Copiar ficheiro PDF para a pasta Templates">
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock
                                            Margin="0,0,8,0"
                                            FontSize="16"
                                            Text="➕" />
                                        <TextBlock FontSize="14" Text="Adicionar Template PDF" />
                                    </StackPanel>
                                    <Button.Style>
                                        <Style TargetType="Button">
                                            <Setter Property="Cursor" Value="Hand" />
                                            <Style.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter Property="Background" Value="#879B83" />
                                                </Trigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Button.Style>
                                </Button>

                                <Border
                                    Margin="0,15,0,0"
                                    Padding="15"
                                    Background="#F7F9F6"
                                    BorderBrush="#E3E9DE"
                                    BorderThickness="1"
                                    CornerRadius="8">
                                    <StackPanel>
                                        <TextBlock
                                            Margin="0,0,0,8"
                                            FontWeight="SemiBold"
                                            Text="📂 Templates Encontrados:" />
                                        <TextBlock
                                            FontSize="12"
                                            FontStyle="Italic"
                                            Foreground="#999"
                                            Text="(Lista de templates será implementada em versão futura)" />
                                    </StackPanel>
                                </Border>
                            </StackPanel>
                        </Border>

                        <!--  Secção Logos e Assinaturas  -->
                        <Border
                            Padding="25"
                            Background="White"
                            BorderBrush="#E3E9DE"
                            BorderThickness="1"
                            CornerRadius="12">
                            <StackPanel>
                                <StackPanel Margin="0,0,0,15" Orientation="Horizontal">
                                    <TextBlock
                                        Margin="0,0,10,0"
                                        FontSize="18"
                                        Text="🖼️" />
                                    <TextBlock
                                        FontSize="16"
                                        FontWeight="SemiBold"
                                        Foreground="{StaticResource TextoPrincipal}"
                                        Text="Logos e Assinaturas" />
                                </StackPanel>

                                <TextBlock
                                    Margin="0,0,0,15"
                                    FontSize="12"
                                    Foreground="{StaticResource TextoSecundario}"
                                    Text="Imagens usadas em cabeçalhos de documentos (geridas na aba 'Dados da Clínica')"
                                    TextWrapping="Wrap" />

                                <Border
                                    Padding="12"
                                    Background="#FEF3C7"
                                    BorderBrush="#FCD34D"
                                    BorderThickness="1"
                                    CornerRadius="8">
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock
                                            Margin="0,0,8,0"
                                            FontSize="14"
                                            Text="ℹ️" />
                                        <TextBlock
                                            FontSize="11"
                                            Foreground="#92400E"
                                            Text="Configuração de logo disponível em Dashboard → Configurações da Clínica"
                                            TextWrapping="Wrap" />
                                    </StackPanel>
                                </Border>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!--  TAB 3: BACKUPS  -->
            <TabItem Header="💾 Backups">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel Margin="30">
                        <TextBlock
                            Margin="0,0,0,20"
                            FontSize="20"
                            FontWeight="SemiBold"
                            Foreground="{StaticResource TextoPrincipal}"
                            Text="💾 Gestão de Backups" />
                        <TextBlock
                            Margin="0,0,0,25"
                            FontSize="13"
                            Foreground="{StaticResource TextoSecundario}"
                            Text="Criar e restaurar backups completos da base de dados"
                            TextWrapping="Wrap" />

                        <!--  Ações de Backup  -->
                        <Border
                            Margin="0,0,0,20"
                            Padding="20"
                            Background="White"
                            BorderBrush="#E3E9DE"
                            BorderThickness="1"
                            CornerRadius="8">
                            <StackPanel>
                                <TextBlock
                                    Margin="0,0,0,15"
                                    FontSize="16"
                                    FontWeight="SemiBold"
                                    Text="📦 Criar Backup" />

                                <TextBlock
                                    Margin="0,0,0,15"
                                    FontSize="13"
                                    Foreground="#666"
                                    Text="Cria um backup completo da base de dados (biodesk.db) em formato ZIP comprimido."
                                    TextWrapping="Wrap" />

                                <StackPanel Orientation="Horizontal">
                                    <Button
                                        Padding="15,8"
                                        Command="{Binding CriarBackupCommand}"
                                        Content="💾 Criar Backup Agora"
                                        Style="{StaticResource PrimaryButtonStyle}"
                                        ToolTip="Cria backup imediato da base de dados" />

                                    <Button
                                        Margin="10,0,0,0"
                                        Padding="15,8"
                                        Command="{Binding AbrirPastaBackupsCommand}"
                                        Content="📂 Abrir Pasta Backups"
                                        Style="{StaticResource SecondaryButtonStyle}"
                                        ToolTip="Abrir pasta onde os backups estão guardados" />

                                    <TextBlock
                                        Margin="15,0,0,0"
                                        VerticalAlignment="Center"
                                        FontSize="12"
                                        Foreground="#666"
                                        Text="{Binding UltimoBackupInfo}"
                                        Visibility="{Binding TemBackups, Converter={StaticResource BoolToVisibility}}" />
                                </StackPanel>
                            </StackPanel>
                        </Border>

                        <!--  Restaurar Backup  -->
                        <Border
                            Margin="0,0,0,20"
                            Padding="20"
                            Background="#FFF3E0"
                            BorderBrush="#FFB300"
                            BorderThickness="2"
                            CornerRadius="8">
                            <StackPanel>
                                <StackPanel Margin="0,0,0,10" Orientation="Horizontal">
                                    <TextBlock
                                        FontSize="20"
                                        FontWeight="Bold"
                                        Foreground="#F57C00"
                                        Text="⚠️" />
                                    <TextBlock
                                        Margin="10,0,0,0"
                                        FontSize="16"
                                        FontWeight="SemiBold"
                                        Foreground="#E65100"
                                        Text="Restaurar Backup" />
                                </StackPanel>

                                <TextBlock
                                    Margin="0,0,0,15"
                                    FontSize="13"
                                    Foreground="#BF360C"
                                    Text="⚠️ ATENÇÃO: Restaurar um backup irá SUBSTITUIR todos os dados atuais. Esta operação não pode ser desfeita!"
                                    TextWrapping="Wrap" />

                                <Button
                                    Padding="15,8"
                                    Command="{Binding RestaurarBackupCommand}"
                                    Content="📥 Restaurar Backup..."
                                    Style="{StaticResource SecondaryButtonStyle}"
                                    ToolTip="Selecionar ficheiro ZIP de backup para restaurar" />
                            </StackPanel>
                        </Border>

                        <!--  Lista de Backups  -->
                        <Border
                            Padding="20"
                            Background="White"
                            BorderBrush="#E3E9DE"
                            BorderThickness="1"
                            CornerRadius="8">
                            <StackPanel>
                                <StackPanel Margin="0,0,0,15" Orientation="Horizontal">
                                    <TextBlock
                                        FontSize="16"
                                        FontWeight="SemiBold"
                                        Text="📋 Backups Disponíveis" />
                                    <Button
                                        Margin="10,0,0,0"
                                        Padding="8,4"
                                        Command="{Binding AtualizarListaBackupsCommand}"
                                        Content="🔄"
                                        Style="{StaticResource SecondaryButtonStyle}"
                                        ToolTip="Atualizar lista" />
                                </StackPanel>

                                <DataGrid
                                    Height="200"
                                    AutoGenerateColumns="False"
                                    CanUserAddRows="False"
                                    CanUserDeleteRows="False"
                                    IsReadOnly="True"
                                    ItemsSource="{Binding BackupsDisponiveis}"
                                    SelectionMode="Single">
                                    <DataGrid.Columns>
                                        <DataGridTextColumn
                                            Width="*"
                                            Binding="{Binding NomeFicheiro}"
                                            Header="Nome do Ficheiro" />
                                        <DataGridTextColumn
                                            Width="150"
                                            Binding="{Binding DataFormatada}"
                                            Header="Data/Hora" />
                                        <DataGridTextColumn
                                            Width="100"
                                            Binding="{Binding TamanhoFormatado}"
                                            Header="Tamanho" />
                                    </DataGrid.Columns>
                                </DataGrid>

                                <TextBlock
                                    Margin="0,10,0,0"
                                    FontSize="12"
                                    Foreground="#666"
                                    Text="💡 Dica: Os backups são criados automaticamente ao fechar a aplicação."
                                    TextWrapping="Wrap" />
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!--  TAB 4: PREFERÊNCIAS  -->
            <TabItem Header="🎨 Preferências">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel Margin="30">
                        <TextBlock
                            Margin="0,0,0,20"
                            FontSize="20"
                            FontWeight="SemiBold"
                            Foreground="{StaticResource TextoPrincipal}"
                            Text="🎨 Preferências do Sistema" />
                        <TextBlock
                            FontStyle="Italic"
                            Foreground="#999"
                            Text="(Funcionalidades futuras: Temas, Idioma, Formato de Data)" />
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!--  TAB 5: SISTEMA  -->
            <TabItem Header="🔧 Sistema">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel Margin="30">
                        <TextBlock
                            Margin="0,0,0,20"
                            FontSize="20"
                            FontWeight="SemiBold"
                            Foreground="{StaticResource TextoPrincipal}"
                            Text="🔧 Informações do Sistema" />

                        <Border
                            Margin="0,0,0,15"
                            Padding="20"
                            Background="White"
                            BorderBrush="#E3E9DE"
                            BorderThickness="1"
                            CornerRadius="8">
                            <StackPanel>
                                <TextBlock
                                    Margin="0,0,0,10"
                                    FontWeight="SemiBold"
                                    Text="💻 Versão" />
                                <TextBlock FontSize="14" Text="BioDeskPro2 v1.0.0" />
                                <TextBlock
                                    Margin="0,5,0,0"
                                    FontSize="12"
                                    Foreground="#999"
                                    Text=".NET 8.0 | WPF | SQLite" />
                            </StackPanel>
                        </Border>

                        <Border
                            Padding="20"
                            Background="White"
                            BorderBrush="#E3E9DE"
                            BorderThickness="1"
                            CornerRadius="8">
                            <StackPanel>
                                <TextBlock
                                    Margin="0,0,0,10"
                                    FontWeight="SemiBold"
                                    Text="💾 Base de Dados" />
                                <TextBlock FontSize="14" Text="biodesk.db (SQLite)" />
                                <Button
                                    Margin="0,10,0,0"
                                    Padding="10,5"
                                    HorizontalAlignment="Left"
                                    Content="📂 Abrir Pasta"
                                    ToolTip="Abrir pasta com ficheiro da base de dados" />
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>
        </TabControl>

        <!--  Rodapé com Botões  -->
        <Border
            Grid.Row="2"
            Padding="0,20,0,0"
            BorderBrush="#E3E9DE"
            BorderThickness="0,1,0,0">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <!--  Botão Cancelar  -->
                <Button
                    Grid.Column="0"
                    Padding="20,12"
                    HorizontalAlignment="Left"
                    Click="BtnCancelar_Click"
                    Content="✖️ Cancelar"
                    Style="{StaticResource SecondaryButtonStyle}" />

                <!--  Botões Direita  -->
                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <Button
                        Margin="0,0,10,0"
                        Padding="20,12"
                        Command="{Binding TestarConexaoCommand}"
                        Content="🧪 Testar Conexão"
                        Style="{StaticResource SecondaryButtonStyle}"
                        ToolTip="Envia um email de teste para verificar configuração" />
                    <Button
                        Padding="20,12"
                        Command="{Binding GuardarConfiguracoesCommand}"
                        Content="💾 Guardar"
                        Style="{StaticResource NavigationButtonStyle}" />
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</Window>
