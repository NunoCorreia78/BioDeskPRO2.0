<UserControl
    x:Class="BioDesk.App.Views.Abas.TerapiasUserControl"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:vm="clr-namespace:BioDesk.ViewModels.UserControls;assembly=BioDesk.ViewModels"
    xmlns:converters="clr-namespace:BioDesk.App.Converters"
    d:DataContext="{d:DesignInstance Type=vm:TerapiasBioenergeticasUserControlViewModel}"
    d:DesignHeight="700"
    d:DesignWidth="1000"
    mc:Ignorable="d"
    Background="{StaticResource FundoPrincipal}">

    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
        <converters:NotEmptyStringToVisibilityConverter x:Key="NotEmptyStringToVisibilityConverter" />
    </UserControl.Resources>

    <ScrollViewer Padding="20" VerticalScrollBarVisibility="Auto">
        <Grid Margin="10">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <!-- === SEÇÃO 1: SELEÇÃO DE PROTOCOLO === -->
            <Border
                Grid.Row="0"
                Margin="0,0,0,20"
                Padding="25"
                Background="White"
                BorderBrush="#E3E9DE"
                BorderThickness="1"
                CornerRadius="12">
                <StackPanel>
                    <TextBlock
                        Margin="0,0,0,20"
                        FontSize="18"
                        FontWeight="SemiBold"
                        Foreground="#3F4A3D"
                        Text="📋 Protocolo Terapêutico" />

                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <!-- Campo de pesquisa de protocolos -->
                        <StackPanel Grid.Column="0" Margin="0,0,15,0">
                            <TextBlock Style="{StaticResource FieldLabelStyle}" Text="Protocolo" />
                            <ComboBox
                                Height="40"
                                IsEditable="True"
                                ItemsSource="{Binding ProtocolosDisponiveis}"
                                SelectedItem="{Binding ProtocoloSelecionado, Mode=TwoWay}"
                                Text="{Binding PesquisaProtocolo, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                ToolTip="Digite para pesquisar nos 1.094 protocolos disponíveis">
                                <ComboBox.ItemTemplate>
                                    <DataTemplate>
                                        <StackPanel>
                                            <TextBlock FontWeight="SemiBold" Text="{Binding Nome}" />
                                            <TextBlock
                                                FontSize="11"
                                                Foreground="#5A6558"
                                                Text="{Binding Descricao}" />
                                        </StackPanel>
                                    </DataTemplate>
                                </ComboBox.ItemTemplate>
                            </ComboBox>
                        </StackPanel>

                        <!-- Informações do protocolo selecionado -->
                        <StackPanel Grid.Column="1" VerticalAlignment="Center">
                            <TextBlock
                                FontSize="12"
                                Foreground="#5A6558"
                                Text="{Binding InfoProtocolo}"
                                TextWrapping="Wrap" />
                        </StackPanel>
                    </Grid>
                </StackPanel>
            </Border>

            <!-- === SEÇÃO 2: SELEÇÃO RNG DE FREQUÊNCIAS === -->
            <Border
                Grid.Row="1"
                Margin="0,0,0,20"
                Padding="25"
                Background="White"
                BorderBrush="#E3E9DE"
                BorderThickness="1"
                CornerRadius="12">
                <StackPanel>
                    <TextBlock
                        Margin="0,0,0,20"
                        FontSize="18"
                        FontWeight="SemiBold"
                        Foreground="#3F4A3D"
                        Text="🎲 Seleção Aleatória de Frequências (RNG)" />

                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>

                        <!-- Número de frequências -->
                        <StackPanel Grid.Column="0" Margin="0,0,20,0">
                            <TextBlock Style="{StaticResource FieldLabelStyle}" Text="Nº Frequências" />
                            <TextBox
                                Width="80"
                                Height="40"
                                VerticalContentAlignment="Center"
                                Text="{Binding NumeroFrequencias, Mode=TwoWay}"
                                ToolTip="Entre 2 e 10 frequências" />
                        </StackPanel>

                        <!-- Fonte de entropia -->
                        <StackPanel Grid.Column="1" Margin="0,0,20,0">
                            <TextBlock Style="{StaticResource FieldLabelStyle}" Text="Fonte de Entropia" />
                            <ComboBox
                                Width="200"
                                Height="40"
                                ItemsSource="{Binding FontesEntropiaDisponiveis}"
                                SelectedItem="{Binding FonteEntropiaSelecionada, Mode=TwoWay}"
                                ToolTip="Selecione a fonte de aleatoriedade" />
                        </StackPanel>

                        <!-- Botão de seleção -->
                        <Button
                            Grid.Column="2"
                            Width="220"
                            Height="45"
                            Margin="0,25,0,0"
                            VerticalAlignment="Bottom"
                            Background="#9CAF97"
                            Command="{Binding SelecionarFrequenciasCommand}"
                            Content="🎲 Selecionar Aleatórias"
                            FontWeight="SemiBold"
                            Foreground="White"
                            IsEnabled="{Binding PodeSelecionarFrequencias}"
                            ToolTip="Usar RNG para selecionar frequências do protocolo" />
                    </Grid>

                    <!-- Lista de frequências selecionadas -->
                    <Border
                        Margin="0,20,0,0"
                        Padding="15"
                        Background="#F7F9F6"
                        BorderBrush="#E3E9DE"
                        BorderThickness="1"
                        CornerRadius="8"
                        Visibility="{Binding TemFrequenciasSelecionadas, Converter={StaticResource BooleanToVisibilityConverter}}">
                        <StackPanel>
                            <TextBlock
                                FontSize="14"
                                FontWeight="SemiBold"
                                Foreground="#3F4A3D"
                                Text="✅ Frequências Selecionadas:" />
                            <ItemsControl Margin="0,10,0,0" ItemsSource="{Binding FrequenciasSelecionadas}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <TextBlock
                                            Margin="5"
                                            FontFamily="Consolas"
                                            FontSize="13"
                                            Foreground="#3F4A3D">
                                            <Run Text="{Binding Frequencia, StringFormat='{}{0:N2} Hz'}" />
                                            <Run Foreground="#5A6558" Text=" - " />
                                            <Run Foreground="#5A6558" Text="{Binding Descricao}" />
                                        </TextBlock>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                    </Border>
                </StackPanel>
            </Border>

            <!-- === SEÇÃO 3: CONFIGURAÇÃO TiePie HS5 === -->
            <Border
                Grid.Row="2"
                Margin="0,0,0,20"
                Padding="25"
                Background="White"
                BorderBrush="#E3E9DE"
                BorderThickness="1"
                CornerRadius="12">
                <StackPanel>
                    <Grid Margin="0,0,0,20">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <TextBlock
                            Grid.Column="0"
                            FontSize="18"
                            FontWeight="SemiBold"
                            Foreground="#3F4A3D"
                            Text="⚡ Configuração TiePie Handyscope HS5" />

                        <!-- Status do hardware -->
                        <Border
                            Grid.Column="1"
                            Padding="10,5"
                            Background="{Binding StatusHardwareBackground}"
                            BorderBrush="{Binding StatusHardwareBorda}"
                            BorderThickness="1"
                            CornerRadius="6">
                            <StackPanel Orientation="Horizontal">
                                <Ellipse
                                    Width="10"
                                    Height="10"
                                    Margin="0,0,8,0"
                                    Fill="{Binding StatusHardwareCor}" />
                                <TextBlock
                                    FontSize="12"
                                    FontWeight="SemiBold"
                                    Foreground="{Binding StatusHardwareTexto}"
                                    Text="{Binding StatusHardware}" />
                            </StackPanel>
                        </Border>
                    </Grid>

                    <UniformGrid
                        Columns="4"
                        Rows="1">
                        <!-- Canal -->
                        <StackPanel Margin="0,0,15,0">
                            <TextBlock Style="{StaticResource FieldLabelStyle}" Text="Canal" />
                            <ComboBox
                                Height="40"
                                ItemsSource="{Binding CanaisDisponiveis}"
                                SelectedItem="{Binding CanalSelecionado, Mode=TwoWay}"
                                ToolTip="Canal de saída do TiePie" />
                        </StackPanel>

                        <!-- Voltagem -->
                        <StackPanel Margin="0,0,15,0">
                            <TextBlock Style="{StaticResource FieldLabelStyle}" Text="Voltagem (V)" />
                            <TextBox
                                Height="40"
                                VerticalContentAlignment="Center"
                                Text="{Binding Voltagem, Mode=TwoWay, StringFormat=N2}"
                                ToolTip="0.2 a 8.0 Volts" />
                        </StackPanel>

                        <!-- Forma de Onda -->
                        <StackPanel Margin="0,0,15,0">
                            <TextBlock Style="{StaticResource FieldLabelStyle}" Text="Forma de Onda" />
                            <ComboBox
                                Height="40"
                                ItemsSource="{Binding FormasOndaDisponiveis}"
                                SelectedItem="{Binding FormaOndaSelecionada, Mode=TwoWay}"
                                ToolTip="Tipo de sinal a gerar" />
                        </StackPanel>

                        <!-- Duração por frequência -->
                        <StackPanel>
                            <TextBlock Style="{StaticResource FieldLabelStyle}" Text="Duração/Freq (s)" />
                            <TextBox
                                Height="40"
                                VerticalContentAlignment="Center"
                                Text="{Binding DuracaoPorFrequencia, Mode=TwoWay}"
                                ToolTip="1 a 300 segundos por frequência" />
                        </StackPanel>
                    </UniformGrid>
                </StackPanel>
            </Border>

            <!-- === ÁREA DE MENSAGENS (Erros/Sucesso) === -->
            <Border
                Grid.Row="3"
                Margin="0,0,0,20"
                Padding="20"
                Background="#FFF8E1"
                BorderBrush="#FFB74D"
                BorderThickness="1"
                CornerRadius="8"
                Visibility="{Binding ErrorMessage, Converter={StaticResource NotEmptyStringToVisibilityConverter}}">
                <TextBlock
                    FontFamily="Consolas"
                    FontSize="13"
                    Foreground="#3F4A3D"
                    Text="{Binding ErrorMessage}"
                    TextWrapping="Wrap" />
            </Border>

            <!-- === SEÇÃO 4: CONTROLES DE EXECUÇÃO === -->
            <Border
                Grid.Row="4"
                Margin="0,0,0,20"
                Padding="25"
                Background="White"
                BorderBrush="#E3E9DE"
                BorderThickness="1"
                CornerRadius="12">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <!-- Indicador de progresso -->
                    <StackPanel
                        Grid.Column="0"
                        VerticalAlignment="Center"
                        Visibility="{Binding IsExecutandoTerapia, Converter={StaticResource BooleanToVisibilityConverter}}">
                        <TextBlock
                            FontSize="14"
                            FontWeight="SemiBold"
                            Foreground="#3F4A3D"
                            Text="⏱️ Terapia em Execução..." />
                        <ProgressBar
                            Height="8"
                            Margin="0,8,0,0"
                            Maximum="{Binding TotalFrequencias}"
                            Value="{Binding FrequenciaAtualIndex}" />
                        <TextBlock
                            Margin="0,5,0,0"
                            FontSize="12"
                            Foreground="#5A6558"
                            Text="{Binding ProgressoTexto}" />
                    </StackPanel>

                    <!-- Botão Testar Hardware -->
                    <Button
                        Grid.Column="1"
                        Width="180"
                        Height="50"
                        Margin="0,0,15,0"
                        Background="#9CAF97"
                        Command="{Binding TestarHardwareCommand}"
                        Content="🧪 Testar Hardware"
                        FontSize="14"
                        FontWeight="SemiBold"
                        Foreground="White"
                        IsEnabled="{Binding IsExecutandoTerapia, Converter={StaticResource InverseBooleanConverter}}"
                        ToolTip="Gerar sinal de teste 1 kHz por 3 segundos" />

                    <!-- Botão Iniciar -->
                    <Button
                        Grid.Column="2"
                        Width="200"
                        Height="50"
                        Margin="0,0,15,0"
                        Background="#6B9F5F"
                        Command="{Binding IniciarTerapiaCommand}"
                        Content="▶️ Iniciar Terapia"
                        FontSize="16"
                        FontWeight="Bold"
                        Foreground="White"
                        IsEnabled="{Binding PodeIniciarTerapia}"
                        ToolTip="Executar sequência de frequências selecionadas" />

                    <!-- Botão Parar -->
                    <Button
                        Grid.Column="3"
                        Width="140"
                        Height="50"
                        Background="#C94C4C"
                        Command="{Binding PararTerapiaCommand}"
                        Content="🛑 Parar"
                        FontSize="14"
                        FontWeight="Bold"
                        Foreground="White"
                        IsEnabled="{Binding IsExecutandoTerapia}"
                        ToolTip="Interromper terapia imediatamente" />
                </Grid>
            </Border>

            <!-- === SEÇÃO 5: HISTÓRICO DE SESSÕES === -->
            <Border
                Grid.Row="5"
                Padding="25"
                Background="White"
                BorderBrush="#E3E9DE"
                BorderThickness="1"
                CornerRadius="12">
                <StackPanel>
                    <TextBlock
                        Margin="0,0,0,15"
                        FontSize="18"
                        FontWeight="SemiBold"
                        Foreground="#3F4A3D"
                        Text="📊 Histórico de Sessões Recentes" />

                    <DataGrid
                        Height="250"
                        AutoGenerateColumns="False"
                        CanUserAddRows="False"
                        CanUserDeleteRows="False"
                        IsReadOnly="True"
                        ItemsSource="{Binding HistoricoSessoes}"
                        SelectionMode="Single">
                        <DataGrid.Columns>
                            <DataGridTextColumn
                                Width="140"
                                Binding="{Binding Data, StringFormat='{}{0:dd/MM/yyyy HH:mm}'}"
                                Header="Data/Hora" />
                            <DataGridTextColumn
                                Width="*"
                                Binding="{Binding Protocolo}"
                                Header="Protocolo" />
                            <DataGridTextColumn
                                Width="80"
                                Binding="{Binding NumFrequencias}"
                                Header="Nº Freq." />
                            <DataGridTextColumn
                                Width="100"
                                Binding="{Binding FonteEntropia}"
                                Header="Entropia" />
                            <DataGridTextColumn
                                Width="80"
                                Binding="{Binding Canal}"
                                Header="Canal" />
                            <DataGridTextColumn
                                Width="90"
                                Binding="{Binding Voltagem, StringFormat='{}{0:N2} V'}"
                                Header="Voltagem" />
                            <DataGridTextColumn
                                Width="100"
                                Binding="{Binding FormaOnda}"
                                Header="Forma Onda" />
                            <DataGridTextColumn
                                Width="90"
                                Binding="{Binding DuracaoTotal, StringFormat='{}{0:N0} s'}"
                                Header="Duração" />
                        </DataGrid.Columns>
                    </DataGrid>
                </StackPanel>
            </Border>
        </Grid>
    </ScrollViewer>
</UserControl>
