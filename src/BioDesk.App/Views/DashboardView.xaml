<UserControl x:Class="BioDesk.App.Views.DashboardView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="clr-namespace:BioDesk.ViewModels;assembly=BioDesk.ViewModels"
             d:DataContext="{d:DesignInstance vm:DashboardViewModel}"
             mc:Ignorable="d">

    <Grid>
        <!-- Fundo gradiente -->
        <Grid.Background>
            <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                <GradientStop Color="#FCFDFB" Offset="0"/>
                <GradientStop Color="#F2F5F0" Offset="1"/>
            </LinearGradientBrush>
        </Grid.Background>

        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/> <!-- Header -->
            <RowDefinition Height="Auto"/> <!-- Pesquisa -->
            <RowDefinition Height="*"/>    <!-- Conteúdo principal -->
        </Grid.RowDefinitions>

        <!-- Header com status e relógio -->
        <Border Grid.Row="0" Style="{StaticResource CartaoStyle}" Margin="16,16,16,8">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Status dos dispositivos -->
                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <TextBlock Text="BioDesk" FontSize="24" FontWeight="Bold" 
                              Foreground="{StaticResource TextoPrincipal}" 
                              VerticalAlignment="Center" Margin="0,0,32,0"/>
                    
                    <!-- Status Online/Offline -->
                    <StackPanel Orientation="Horizontal" Margin="0,0,16,0">
                        <Ellipse Width="12" Height="12" Fill="{StaticResource StatusOnline}" 
                                VerticalAlignment="Center" Margin="0,0,4,0"/>
                        <TextBlock Text="{Binding StatusConexao}" 
                                  Foreground="{StaticResource TextoSecundario}" 
                                  VerticalAlignment="Center"/>
                    </StackPanel>

                    <!-- Status Iridoscópio -->
                    <StackPanel Orientation="Horizontal" Margin="0,0,16,0">
                        <Ellipse Width="12" Height="12" Fill="{StaticResource StatusNaoDetectado}" 
                                VerticalAlignment="Center" Margin="0,0,4,0"/>
                        <TextBlock Text="Iridoscópio" 
                                  Foreground="{StaticResource TextoSecundario}" 
                                  VerticalAlignment="Center"/>
                    </StackPanel>

                    <!-- Status Osciloscópio -->
                    <StackPanel Orientation="Horizontal">
                        <Ellipse Width="12" Height="12" Fill="{StaticResource StatusNaoDetectado}" 
                                VerticalAlignment="Center" Margin="0,0,4,0"/>
                        <TextBlock Text="Osciloscópio" 
                                  Foreground="{StaticResource TextoSecundario}" 
                                  VerticalAlignment="Center"/>
                    </StackPanel>
                </StackPanel>

                <!-- Relógio e Data -->
                <StackPanel Grid.Column="1" HorizontalAlignment="Right">
                    <TextBlock Text="{Binding HoraAtual, StringFormat='{}{0:HH:mm:ss}'}" 
                              FontSize="18" FontWeight="Medium"
                              Foreground="{StaticResource TextoPrincipal}" 
                              HorizontalAlignment="Right"/>
                    <TextBlock Text="{Binding HoraAtual, StringFormat='{}{0:dddd, dd/MM/yyyy}'}" 
                              FontSize="12"
                              Foreground="{StaticResource TextoSecundario}" 
                              HorizontalAlignment="Right"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Pesquisa global -->
        <Border Grid.Row="1" Style="{StaticResource CartaoStyle}" Margin="16,8,16,8">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <TextBox Grid.Column="0" 
                         Text="{Binding PesquisarTexto, UpdateSourceTrigger=PropertyChanged}"
                         FontSize="16" Padding="12,8"
                         Background="White"
                         BorderBrush="{StaticResource CorBorda}"
                         BorderThickness="1">
                    <TextBox.Style>
                        <Style TargetType="TextBox">
                            <Style.Triggers>
                                <Trigger Property="Text" Value="">
                                    <Setter Property="Background">
                                        <Setter.Value>
                                            <VisualBrush Opacity="0.5" Stretch="None" AlignmentX="Left">
                                                <VisualBrush.Visual>
                                                    <TextBlock Text="Pesquisar paciente..." 
                                                              FontSize="16" 
                                                              Foreground="{StaticResource TextoSecundario}"
                                                              Margin="12,8"/>
                                                </VisualBrush.Visual>
                                            </VisualBrush>
                                        </Setter.Value>
                                    </Setter>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </TextBox.Style>
                    <TextBox.InputBindings>
                        <KeyBinding Key="Enter" Command="{Binding PesquisarCommand}"/>
                    </TextBox.InputBindings>
                </TextBox>

                <Button Grid.Column="1" 
                        Command="{Binding PesquisarCommand}"
                        Style="{StaticResource BotaoPrincipalStyle}"
                        Margin="8,0,0,0" Padding="16,8">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="🔍" FontSize="14" Margin="0,0,4,0"/>
                        <TextBlock Text="Pesquisar"/>
                    </StackPanel>
                </Button>
            </Grid>
        </Border>

        <!-- Conteúdo principal em grid -->
        <Grid Grid.Row="2" Margin="16,8,16,16">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- Cards de navegação -->
            <Grid Grid.Row="0" Margin="0,0,0,16">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!-- Novo Paciente -->
                <Border Grid.Column="0" Style="{StaticResource CartaoStyle}" Margin="0,0,8,0">
                    <StackPanel>
                        <TextBlock Text="Novo Paciente" Style="{StaticResource TituloStyle}"/>
                        <TextBlock Text="Cria uma ficha e começa o registo clínico." 
                                  Style="{StaticResource SubtituloStyle}"/>
                        <Button Command="{Binding NovoPacienteCommand}"
                                Style="{StaticResource BotaoPrincipalStyle}"
                                HorizontalAlignment="Left">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="👤" FontSize="14" Margin="0,0,8,0"/>
                                <TextBlock Text="Novo"/>
                            </StackPanel>
                        </Button>
                    </StackPanel>
                </Border>

                <!-- Lista de Pacientes -->
                <Border Grid.Column="1" Style="{StaticResource CartaoStyle}" Margin="8,0,0,0">
                    <StackPanel>
                        <TextBlock Text="Lista de Pacientes" Style="{StaticResource TituloStyle}"/>
                        <TextBlock Text="Consulta e pesquisa registos." 
                                  Style="{StaticResource SubtituloStyle}"/>
                        <Button Command="{Binding AbrirListaPacientesCommand}"
                                Style="{StaticResource BotaoPrincipalStyle}"
                                HorizontalAlignment="Left">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="📋" FontSize="14" Margin="0,0,8,0"/>
                                <TextBlock Text="Abrir"/>
                            </StackPanel>
                        </Button>
                    </StackPanel>
                </Border>
            </Grid>

            <!-- Área inferior -->
            <Grid Grid.Row="1">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!-- Pacientes Recentes -->
                <Border Grid.Column="0" Style="{StaticResource CartaoStyle}" Margin="0,0,8,0">
                    <StackPanel>
                        <TextBlock Text="Pacientes Recentes" Style="{StaticResource TituloStyle}"/>
                        
                        <ScrollViewer MaxHeight="300" VerticalScrollBarVisibility="Auto">
                            <ItemsControl ItemsSource="{Binding PacientesRecentes}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Button Command="{Binding DataContext.SelecionarPacienteRecenteCommand, 
                                                         RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                CommandParameter="{Binding}"
                                                Background="Transparent"
                                                BorderThickness="0"
                                                Padding="8"
                                                Margin="0,2"
                                                HorizontalAlignment="Stretch"
                                                HorizontalContentAlignment="Left"
                                                Cursor="Hand">
                                            <Button.Style>
                                                <Style TargetType="Button">
                                                    <Style.Triggers>
                                                        <Trigger Property="IsMouseOver" Value="True">
                                                            <Setter Property="Background" Value="{StaticResource CorBorda}"/>
                                                        </Trigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Button.Style>
                                            <StackPanel>
                                                <TextBlock Text="{Binding NomeCompleto}" 
                                                          FontWeight="Medium"
                                                          Foreground="{StaticResource TextoPrincipal}"/>
                                                <TextBlock Text="{Binding DataUltimaAtualizacao, StringFormat='Última atualização: {0:dd/MM/yyyy HH:mm}'}" 
                                                          FontSize="11"
                                                          Foreground="{StaticResource TextoSecundario}"/>
                                            </StackPanel>
                                        </Button>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>
                    </StackPanel>
                </Border>

                <!-- Histórico de Envios -->
                <Border Grid.Column="1" Style="{StaticResource CartaoStyle}" Margin="8,0,0,0">
                    <StackPanel>
                        <TextBlock Text="📧 Histórico de Envios" Style="{StaticResource TituloStyle}"/>
                        
                        <StackPanel Margin="0,8">
                            <Button Background="Transparent" BorderThickness="0" 
                                   HorizontalAlignment="Left" Padding="0,4"
                                   Cursor="Hand">
                                <TextBlock Text="Consentimento assinado" 
                                          Foreground="{StaticResource TextoSecundario}"
                                          TextDecorations="Underline"/>
                            </Button>
                            
                            <Button Background="Transparent" BorderThickness="0" 
                                   HorizontalAlignment="Left" Padding="0,4"
                                   Cursor="Hand">
                                <TextBlock Text="Relatório enviado" 
                                          Foreground="{StaticResource TextoSecundario}"
                                          TextDecorations="Underline"/>
                            </Button>
                            
                            <Button Background="Transparent" BorderThickness="0" 
                                   HorizontalAlignment="Left" Padding="0,4"
                                   Cursor="Hand">
                                <TextBlock Text="Plano terapêutico" 
                                          Foreground="{StaticResource TextoSecundario}"
                                          TextDecorations="Underline"/>
                            </Button>
                        </StackPanel>
                    </StackPanel>
                </Border>
            </Grid>
        </Grid>

        <!-- Loading overlay -->
        <Border Grid.RowSpan="3" 
                Background="#80000000">
            <Border.Style>
                <Style TargetType="Border">
                    <Setter Property="Visibility" Value="Collapsed"/>
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding IsLoading}" Value="True">
                            <Setter Property="Visibility" Value="Visible"/>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </Border.Style>
            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                <ProgressBar IsIndeterminate="True" Width="200" Height="4" 
                            Foreground="{StaticResource BotaoPrincipal}"/>
                <TextBlock Text="A carregar..." 
                          Foreground="White" 
                          HorizontalAlignment="Center" 
                          Margin="0,8,0,0"/>
            </StackPanel>
        </Border>

        <!-- Error message -->
        <Border Grid.RowSpan="3" 
                Background="#80FF0000">
            <Border.Style>
                <Style TargetType="Border">
                    <Setter Property="Visibility" Value="Collapsed"/>
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding ErrorMessage}" Value="">
                            <Setter Property="Visibility" Value="Collapsed"/>
                        </DataTrigger>
                        <DataTrigger Binding="{Binding ErrorMessage}" Value="{x:Null}">
                            <Setter Property="Visibility" Value="Collapsed"/>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </Border.Style>
            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                <TextBlock Text="{Binding ErrorMessage}" 
                          Foreground="White" 
                          FontWeight="Bold"
                          HorizontalAlignment="Center"/>
            </StackPanel>
        </Border>
    </Grid>
</UserControl>